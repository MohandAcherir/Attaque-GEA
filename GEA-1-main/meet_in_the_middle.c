#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include "lfsr.h"
#include "table_builder.h"
#include "util.h"

uint64_t base_T[24] = {
0b1000000000000000000000001001110011110011100110000010011111010101UL,
0b0100000000000000000000001101000001111001110011000001001100001100UL,
0b0010000000000000000000000110100000111100111001100000100110000110UL,
0b0001000000000000000000000011010000011110011100110000010011000011UL,
0b0000100000000000000000001000010000001111001110011000001010000111UL,
0b0000010000000000000000001101110000000111100111001100000110100101UL,
0b0000001000000000000000001111000000000011110011100110000000110100UL,
0b0000000100000000000000000111100000000001111001110011000000011010UL,
0b0000000010000000000000000011110000000000111100111001100000001101UL,
0b0000000001000000000000001000000000000000011110011100110011100000UL,
0b0000000000100000000000000100000000000000001111001110011001110000UL,
0b0000000000010000000000000010000000000000000111100111001100111000UL,
0b0000000000001000000000000001000000000000000011110011100110011100UL,
0b0000000000000100000000000000100000000000000001111001110011001110UL,
0b0000000000000010000000000000010000000000000000111100111001100111UL,
0b0000000000000001000000001001110000000000000000011110011111010101UL,
0b0000000000000000100000001101000000000000000000001111001100001100UL,
0b0000000000000000010000000110100000000000000000000111100110000110UL,
0b0000000000000000001000000011010000000000000000000011110011000011UL,
0b0000000000000000000100001000010000000000000000000001111010000111UL,
0b0000000000000000000010001101110000000000000000000000111110100101UL,
0b0000000000000000000001001111000000000000000000000000011100110100UL,
0b0000000000000000000000100111100000000000000000000000001110011010UL,
0b0000000000000000000000010011110000000000000000000000000111001101UL};

const uint64_t base_U_B[32] = {
0b1000000000000000000000000000000010000010100101111010011000111110UL,
0b0100000000000000000000000000000001110110011111001001101010111011UL,
0b0010000000000000000000000000000010111001101010011110101101100011UL,
0b0001000000000000000000000000000011101001011101000001101000101011UL,
0b0000100000000000000000000000000011110110001011011010101100101011UL,
0b0000010000000000000000000000000011001110101101100011101000001111UL,
0b0000001000000000000000000000000011100101110011001011101100111001UL,
0b0000000100000000000000000000000011110000011100011111101110100010UL,
0b0000000010000000000000000000000001001111000011111011010001110101UL,
0b0000000001000000000000000000000010010010001001110011010110100000UL,
0b0000000000100000000000000000000001111110001001001101001101110100UL,
0b0000000000010000000000000000000000111111000100100110100110111010UL,
0b0000000000001000000000000000000000011111100010010011010011011101UL,
0b0000000000000100000000000000000010111010011001000111010111110100UL,
0b0000000000000010000000000000000001011101001100100011101011111010UL,
0b0000000000000001000000000000000000101110100110010001110101111101UL,
0b0000000000000000100000000000000010100010111011000110000100100100UL,
0b0000000000000000010000000000000001010001011101100011000010010010UL,
0b0000000000000000001000000000000000101000101110110001100001001001UL,
0b0000000000000000000100000000000010100001111111010110001110111110UL,
0b0000000000000000000010000000000001100111110010011111100001111011UL,
0b0000000000000000000001000000000010000110010001000001001110100111UL,
0b0000000000000000000000100000000011000001101101011010111111101101UL,
0b0000000000000000000000010000000011010101011110100011100001101100UL,
0b0000000000000000000000001000000001101010101111010001110000110110UL,
0b0000000000000000000000000100000000000010011010011100011110111111UL,
0b0000000000000000000000000010000010110100100101000000110001000101UL,
0b0000000000000000000000000001000011011000110111011010000000011100UL,
0b0000000000000000000000000000100001011011010110011001100110101010UL,
0b0000000000000000000000000000010000011010100110111000010101110001UL,
0b0000000000000000000000000000001010111000111011010010110100100010UL,
0b0000000000000000000000000000000101101011010000011101111100110101UL};



/**
 * Renvoie t si z1, z2 est trouvé dans Tab[v], -1 sinon
*/
int find(tuple *arr, uint64_t z1, uint8_t z2) {
    tuple curTuple;
    int l = 0;
    int r = (1 << 24) - 1; // check -1
    int m;
    while (l <= r){
      m = l + (r - l) / 2;
      curTuple = arr[m];
      if  (curTuple.out1 == z1 && curTuple.out2 == z2) {
        return curTuple.t;
      }
      if (curTuple.out1 > z1 || (curTuple.out1 == z1 && curTuple.out2 > z2)) {
        r = m - 1;
      } else { 
        l = m + 1;
      }
    }
    return -1;
}


void meet_in_the_middle(uint64_t z1, uint8_t z2) {
  FILE *f;
  char *filename = malloc(20 * sizeof(char));
  int resultat;
  Lfsr A;
  Lfsr C;
  init_lfsr(&A, 1);
  init_lfsr(&C, 3);
  uint64_t a1, c1;
  uint8_t a2, c2;
  uint64_t curVector;
  tuple *arr = malloc((1 << 24) * sizeof(tuple));
  for (uint64_t v = 0; v < (1UL << 8); v++) {
    sprintf(filename, "./tabs/tab_%ld", v);
    f = fopen(filename, "rb");
    printf("ouverture tab_%ld %s\n", v, (fread(arr, (1 << 24) * sizeof(tuple), 1, f) == 1) ? "succes" : "echec");
    for (uint64_t u = 0; u < (1UL << 32); u++) {
      curVector = v;
      for (int i = 0; i < 32; i++) {
        if ((u >> i) & 1) {
          curVector ^= base_U_B[i];
        }
      }
      // curVector = u + v
      lfsr_init(&A, curVector);
      lfsr_init(&C, curVector);
      output_65_bits(&A, &a1, &a2);
      output_65_bits(&C, &c1, &c2);
      resultat = find(arr, a1 ^ c1 ^ z1, a2 ^ c2 ^ z2);
      if (resultat != -1) {
        printf("Candidat trouvé :\n");
        printf("t : ");
        printBint((uint64_t) resultat);
        printf("u : ");
        printBint(u);
        printf("v : ");
        printBint(v);
        exit(0); // saal
      }
    }
    free(arr);
    fclose(f);
  }
  free(filename);
}


int main(int argc, char const *argv[])
{
  //buildTableB(0UL);
  uint64_t s = base_U_B[0] ^ base_U_B[1] ^ base_U_B[2] ^ base_U_B[3] ^ base_T[7];
  Lfsr A,B,C;
  init_lfsr(&A, 1);
  init_lfsr(&B, 2);
  init_lfsr(&C, 3);

  lfsr_init(&A, s);
  lfsr_init(&B, s);
  lfsr_init(&C, s);

  uint64_t output1;
  uint8_t output2;
  uint64_t z1 = 0UL;
  uint8_t z2 = 0;

  output_65_bits(&B, &output1, &output2);
  z1 ^= output1;
  z2 ^= output2;
  output_65_bits(&A, &output1, &output2);
  z1 ^= output1;
  z2 ^= output2;
  output_65_bits(&C, &output1, &output2);
  z1 ^= output1;
  z2 ^= output2;
  meet_in_the_middle(z1, z2);
  return 0;
}
